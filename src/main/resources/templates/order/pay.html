<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment</title>
</head>
<body>
<h1>결제 페이지</h1>
<h2>선택한 상품들</h2>
<table>
    <thead>
    <tr>
        <th>상품명</th>
        <th>수량</th>
        <th>가격</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="item : ${selectedItems}">
        <td th:text="${item.product_name}"></td>
        <td th:text="${item.count}"></td>
        <td th:text="${item.unit_price * item.count}"></td>
    </tr>
    </tbody>
</table>
<h2>총 가격: <span th:text="${totalPrice}"></span></h2>
<h2>배송 정보</h2>
<form id="payment-form">
    <label>이름: <input type="text" name="name" th:value="${member.name}"></label><br>
    <label>전화번호: <input type="text" name="phone" th:value="${member.phone}"></label><br>
    <label>주소: <input type="text" name="address" th:value="${member.address}"></label><br>
    <label>이메일: <input type="text" name="email" th:value="${member.email}"></label><br>

    <h2>결제 방법</h2>
    <div class="payment-options">
        <label><input type="radio" name="pay_method" value="card" checked>신용카드</label>
        <label><input type="radio" name="pay_method" value="trans">실시간 계좌이체</label>
        <label><input type="radio" name="pay_method" value="vbank">가상계좌</label>
        <label><input type="radio" name="pay_method" value="phone">휴대폰 소액결제</label>
    </div>
    <button type="button" onclick="requestPay()">결제하기</button>
</form>

<!-- jQuery -->
<script type="text/javascript"
        src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<!-- iamport.payment.js -->
<script type="text/javascript"
        src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
<script>
    function requestPay() {
        var IMP = window.IMP;
        IMP.init('imp81357167'); // 여기에 아임포트 식별코드 입력

        var form = document.getElementById('payment-form');
        var payMethod = form.pay_method.value;

        /* var memberId =   member ID 가져오기 */;
        var merchantUid = 'merchant_' + new Date().getTime();

        IMP.request_pay({
            pg: 'html5_inicis', // 결제 연동할 PG사
            pay_method: payMethod,
            merchant_uid: merchantUid,
            name: '주문명: 결제 테스트',
            /*amount:  결제할 금액 ,*/
            buyer_email: form.email.value,
            buyer_name: form.name.value,
            buyer_tel: form.phone.value,
            buyer_addr: form.address.value,
        }, function (rsp) {
            if (rsp.success) {
                fetch('/order/pay/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        payMethod: payMethod,
                        /*    itemIds: 선택한 아이템 ID 리스트 ,*/
                        memberId: memberId,
                        merchantUid: merchantUid
                    })
                }).then(response => {
                    if (response.ok) {
                        location.href = '/order/success';
                    }
                });
            } else {
                alert('결제에 실패하였습니다. 에러 내용: ' + rsp.error_msg);
            }
        });
    }
</script>
</body>
</html>
